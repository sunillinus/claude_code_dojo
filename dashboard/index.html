<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Dojo - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dojo: {
                            dark: '#1a1a2e',
                            darker: '#16213e',
                            accent: '#e94560',
                            gold: '#ffd700',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .progress-ring { transform: rotate(-90deg); }
    </style>
</head>
<body class="bg-dojo-dark text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-2">ü•ã Claude Code Dojo</h1>
            <p class="text-gray-400">Master Claude Code through hands-on challenges</p>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <!-- Level Card -->
            <div class="bg-dojo-darker rounded-xl p-6 text-center">
                <div class="text-5xl font-bold text-dojo-accent mb-2" id="level">1</div>
                <div class="text-gray-400 text-sm">LEVEL</div>
            </div>

            <!-- XP Card -->
            <div class="bg-dojo-darker rounded-xl p-6 text-center">
                <div class="text-3xl font-bold mb-2">
                    <span id="xp">0</span>
                    <span class="text-gray-500 text-lg">/ <span id="xpNext">100</span></span>
                </div>
                <div class="text-gray-400 text-sm">EXPERIENCE</div>
                <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                    <div class="bg-dojo-accent h-2 rounded-full transition-all" id="xpBar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Streak Card -->
            <div class="bg-dojo-darker rounded-xl p-6 text-center">
                <div class="text-5xl font-bold text-orange-500 mb-2">üî• <span id="streak">0</span></div>
                <div class="text-gray-400 text-sm">DAY STREAK</div>
            </div>

            <!-- Challenges Card -->
            <div class="bg-dojo-darker rounded-xl p-6 text-center">
                <div class="text-3xl font-bold mb-2">
                    <span id="completed">0</span>
                    <span class="text-gray-500 text-lg">/ 70</span>
                </div>
                <div class="text-gray-400 text-sm">CHALLENGES</div>
            </div>
        </div>

        <!-- Modules Grid -->
        <h2 class="text-2xl font-bold mb-4">Modules</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="modulesGrid">
            <!-- Populated by JavaScript -->
        </div>

        <!-- Badges Section -->
        <h2 class="text-2xl font-bold mb-4">Badges</h2>
        <div class="bg-dojo-darker rounded-xl p-6 mb-8">
            <div class="flex flex-wrap gap-4" id="badgesContainer">
                <div class="text-gray-500" id="noBadges">Complete challenges to earn badges!</div>
            </div>
        </div>

        <!-- Quiz Results Section -->
        <h2 class="text-2xl font-bold mb-4">Quiz Results</h2>
        <div class="bg-dojo-darker rounded-xl p-6 mb-8" id="quizSection">
            <div class="text-gray-500" id="noQuizzes">Run <code class="bg-gray-700 px-2 py-1 rounded text-sm">/dojo quiz</code> to test your knowledge!</div>
            <div id="quizContent" style="display: none;">
                <!-- Diagnostic Score -->
                <div id="diagnosticResult" style="display: none;" class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-dojo-accent">Latest Diagnostic</h3>
                    <div class="flex items-center gap-4 mb-3">
                        <div class="text-3xl font-bold"><span id="diagScore">0</span><span class="text-gray-500 text-lg">/15</span></div>
                        <div class="text-sm text-gray-400" id="diagDate"></div>
                        <div id="diagImprovement" class="text-sm font-semibold" style="display: none;"></div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2" id="diagModules"></div>
                </div>
                <!-- Module Quiz History -->
                <div id="moduleQuizResults" style="display: none;">
                    <h3 class="text-lg font-semibold mb-3 text-dojo-accent">Module Quizzes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="moduleQuizGrid"></div>
                </div>
            </div>
        </div>

        <!-- Skills Progress -->
        <h2 class="text-2xl font-bold mb-4">Skills Progress</h2>
        <div class="bg-dojo-darker rounded-xl p-6" id="skillsContainer">
            <div class="text-gray-500">Complete challenges to track skill progress!</div>
        </div>
    </div>

    <script>
        // Badge definitions
        const BADGES = {
            'first-challenge': { name: 'First Blood', icon: '‚öîÔ∏è', description: 'Complete your first challenge' },
            'fundamentals-complete': { name: 'Foundation', icon: 'üèóÔ∏è', description: 'Complete Fundamentals module' },
            'streak-7': { name: 'Week Warrior', icon: 'üî•', description: '7-day streak' },
            'streak-30': { name: 'Month Master', icon: 'üí´', description: '30-day streak' },
            'no-hints-5': { name: 'Self-Reliant', icon: 'üß†', description: 'Complete 5 challenges without hints' },
            'speed-demon': { name: 'Speed Demon', icon: '‚ö°', description: 'Complete advanced challenge in under 2 minutes' },
            'git-guru': { name: 'Git Guru', icon: 'üìö', description: 'Master all Git challenges' },
            'all-complete': { name: 'Dojo Master', icon: 'ü•ã', description: 'Complete all 70 challenges' },
            'quiz-ace': { name: 'Quiz Ace', icon: 'üéØ', description: 'Score 100% on a module quiz' }
        };

        // Module config
        const MODULES = [
            { id: 'fundamentals', name: 'Fundamentals', icon: 'üìÅ', total: 5 },
            { id: 'search-navigation', name: 'Search & Nav', icon: 'üîç', total: 5 },
            { id: 'git-basics', name: 'Git Basics', icon: 'üìö', total: 5 },
            { id: 'code-editing', name: 'Code Editing', icon: '‚úèÔ∏è', total: 5 },
            { id: 'debugging', name: 'Debugging', icon: 'üêõ', total: 4 },
            { id: 'testing-tdd', name: 'Testing & TDD', icon: 'üß™', total: 5 },
            { id: 'project-config', name: 'Project Config', icon: '‚öôÔ∏è', total: 5 },
            { id: 'effective-prompting', name: 'Prompting', icon: 'üí¨', total: 4 },
            { id: 'code-generation', name: 'Code Gen', icon: 'üèóÔ∏è', total: 4 },
            { id: 'web-research', name: 'Web Research', icon: 'üåê', total: 4 },
            { id: 'subagents', name: 'Subagents', icon: 'ü§ñ', total: 4 },
            { id: 'background-tasks', name: 'Background', icon: '‚è≥', total: 4 },
            { id: 'agentic-loops', name: 'Ralph Loop', icon: 'üîÑ', total: 4 },
            { id: 'skills-hooks', name: 'Skills & Hooks', icon: 'ü™ù', total: 4 },
            { id: 'mcp-integration', name: 'MCP', icon: 'üîå', total: 3 },
            { id: 'plugin-development', name: 'Plugin Dev', icon: 'üì¶', total: 5 }
        ];

        async function fetchData() {
            try {
                const progressRes = await fetch('/api/progress');
                const progress = await progressRes.json();

                const challengesRes = await fetch('/api/challenges');
                const challenges = await challengesRes.json();

                return { progress, challenges };
            } catch (error) {
                console.error('Failed to fetch data:', error);
                return { progress: null, challenges: null };
            }
        }

        function updateUI(data) {
            const { progress, challenges } = data;

            if (!progress) return;

            // Update stats
            document.getElementById('level').textContent = progress.xp?.level || 1;
            document.getElementById('xp').textContent = progress.xp?.total || 0;
            document.getElementById('xpNext').textContent = (progress.xp?.total || 0) + (progress.xp?.toNextLevel || 100);
            document.getElementById('streak').textContent = progress.streak?.current || 0;
            document.getElementById('completed').textContent = progress.stats?.totalChallengesCompleted || 0;

            // XP bar
            const xpPercent = progress.xp?.toNextLevel
                ? Math.min(100, (progress.xp.total % (progress.xp.toNextLevel + progress.xp.total)) / (progress.xp.toNextLevel + progress.xp.total) * 100)
                : 0;
            document.getElementById('xpBar').style.width = `${xpPercent}%`;

            // Modules
            const modulesGrid = document.getElementById('modulesGrid');
            modulesGrid.innerHTML = MODULES.map(mod => {
                const moduleProgress = progress.modules?.[mod.id] || { completed: 0, total: mod.total, unlocked: mod.id === 'fundamentals' || mod.id === 'search-navigation' };
                const percent = (moduleProgress.completed / mod.total) * 100;
                const isLocked = !moduleProgress.unlocked;

                return `
                    <div class="bg-gray-800 rounded-xl p-4 ${isLocked ? 'opacity-50' : ''}">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-2xl">${mod.icon}</span>
                            ${isLocked ? '<span class="text-xs bg-gray-700 px-2 py-1 rounded">üîí Locked</span>' : ''}
                        </div>
                        <h3 class="font-semibold mb-1">${mod.name}</h3>
                        <div class="text-sm text-gray-400 mb-2">${moduleProgress.completed}/${mod.total} complete</div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Badges
            const badgesContainer = document.getElementById('badgesContainer');
            const earnedBadges = progress.badges || [];

            if (earnedBadges.length > 0) {
                document.getElementById('noBadges').style.display = 'none';
                badgesContainer.innerHTML = earnedBadges.map(badgeId => {
                    const badge = BADGES[badgeId] || { name: badgeId, icon: 'üèÜ', description: '' };
                    return `
                        <div class="flex items-center gap-3 bg-gray-800 rounded-lg px-4 py-3">
                            <span class="text-3xl">${badge.icon}</span>
                            <div>
                                <div class="font-semibold">${badge.name}</div>
                                <div class="text-xs text-gray-400">${badge.description}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Skills
            const skillsContainer = document.getElementById('skillsContainer');
            const skills = progress.skills || {};

            if (Object.keys(skills).length > 0) {
                skillsContainer.innerHTML = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${Object.entries(skills).map(([skillId, data]) => `
                            <div class="text-center">
                                <div class="text-lg font-semibold">${skillId.replace(/-/g, ' ')}</div>
                                <div class="text-3xl font-bold text-dojo-accent">Lv.${data.level || 1}</div>
                                <div class="text-xs text-gray-400">${data.xp || 0} XP</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Quiz Results
            const quizzes = progress.quizzes || { diagnostic: [], modules: {} };
            const hasDiagnostic = quizzes.diagnostic && quizzes.diagnostic.length > 0;
            const hasModuleQuizzes = quizzes.modules && Object.keys(quizzes.modules).length > 0;

            if (hasDiagnostic || hasModuleQuizzes) {
                document.getElementById('noQuizzes').style.display = 'none';
                document.getElementById('quizContent').style.display = 'block';
            }

            if (hasDiagnostic) {
                const latest = quizzes.diagnostic[quizzes.diagnostic.length - 1];
                document.getElementById('diagnosticResult').style.display = 'block';
                document.getElementById('diagScore').textContent = latest.totalCorrect;
                document.getElementById('diagDate').textContent = new Date(latest.takenAt).toLocaleDateString();

                // Show improvement if more than one attempt
                if (quizzes.diagnostic.length > 1) {
                    const prev = quizzes.diagnostic[quizzes.diagnostic.length - 2];
                    const delta = latest.totalCorrect - prev.totalCorrect;
                    const improvEl = document.getElementById('diagImprovement');
                    improvEl.style.display = 'inline';
                    if (delta > 0) {
                        improvEl.textContent = `+${delta} improvement`;
                        improvEl.className = 'text-sm font-semibold text-green-400';
                    } else if (delta < 0) {
                        improvEl.textContent = `${delta} from last`;
                        improvEl.className = 'text-sm font-semibold text-red-400';
                    } else {
                        improvEl.textContent = 'Same as last';
                        improvEl.className = 'text-sm font-semibold text-gray-400';
                    }
                }

                // Module results grid
                const moduleNames = {
                    'fundamentals': 'Fundamentals', 'search-navigation': 'Search & Nav',
                    'code-editing': 'Code Editing', 'debugging': 'Debugging',
                    'testing-tdd': 'Testing & TDD', 'project-config': 'Project Config',
                    'effective-prompting': 'Prompting', 'code-generation': 'Code Gen',
                    'web-research': 'Web Research', 'subagents': 'Subagents',
                    'background-tasks': 'Background', 'agentic-loops': 'Ralph Loop',
                    'skills-hooks': 'Skills & Hooks', 'mcp-integration': 'MCP',
                    'plugin-development': 'Plugin Dev'
                };
                document.getElementById('diagModules').innerHTML = Object.entries(latest.scores || {}).map(([mod, passed]) => `
                    <div class="flex items-center gap-2 bg-gray-800 rounded px-3 py-2 text-sm">
                        <span>${passed ? '‚úÖ' : '‚ùå'}</span>
                        <span class="${passed ? 'text-gray-300' : 'text-red-300'}">${moduleNames[mod] || mod}</span>
                    </div>
                `).join('');
            }

            if (hasModuleQuizzes) {
                document.getElementById('moduleQuizResults').style.display = 'block';
                const moduleNames = {
                    'fundamentals': 'Fundamentals', 'search-navigation': 'Search & Nav',
                    'code-editing': 'Code Editing', 'debugging': 'Debugging',
                    'testing-tdd': 'Testing & TDD', 'project-config': 'Project Config',
                    'effective-prompting': 'Prompting', 'code-generation': 'Code Gen',
                    'web-research': 'Web Research', 'subagents': 'Subagents',
                    'background-tasks': 'Background', 'agentic-loops': 'Ralph Loop',
                    'skills-hooks': 'Skills & Hooks', 'mcp-integration': 'MCP',
                    'plugin-development': 'Plugin Dev'
                };
                document.getElementById('moduleQuizGrid').innerHTML = Object.entries(quizzes.modules).map(([modId, attempts]) => {
                    const latest = attempts[attempts.length - 1];
                    const pct = Math.round((latest.correct / latest.total) * 100);
                    const isPerfect = latest.correct === latest.total;
                    const barColor = isPerfect ? 'bg-dojo-gold' : pct >= 60 ? 'bg-green-500' : 'bg-red-500';
                    let trend = '';
                    if (attempts.length > 1) {
                        const prev = attempts[attempts.length - 2];
                        const delta = latest.correct - prev.correct;
                        if (delta > 0) trend = `<span class="text-green-400 text-xs">+${delta}</span>`;
                        else if (delta < 0) trend = `<span class="text-red-400 text-xs">${delta}</span>`;
                    }
                    return `
                        <div class="bg-gray-800 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-sm">${moduleNames[modId] || modId}</span>
                                <span class="text-sm">${latest.correct}/${latest.total} ${trend}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2">
                                <div class="${barColor} h-2 rounded-full transition-all" style="width: ${pct}%"></div>
                            </div>
                            ${isPerfect ? '<div class="text-xs text-dojo-gold mt-1">üéØ Perfect!</div>' : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        // Initial load
        fetchData().then(updateUI);

        // Auto-refresh every 5 seconds
        setInterval(() => fetchData().then(updateUI), 5000);
    </script>
</body>
</html>
