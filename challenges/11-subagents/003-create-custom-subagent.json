{
  "id": "11-003",
  "module": "subagents",
  "title": "Resume & Deep Dive",
  "description": "Learn to resume subagents for follow-up work and use specialized agent types to find and remove dead code from a real project.\n\n## Agent Resumption\n\nEvery subagent returns an **agent ID** when it finishes. This ID lets you continue the agent's work with its full context preserved:\n\n```\n[Agent finishes] -> agentId: abc123\n\nYou: \"Resume that agent to dig deeper into the auth module\"\nClaude Code: resumes agent abc123 with full prior context\n```\n\nThis is powerful because:\n- The agent remembers everything it already found\n- No need to re-explain context or repeat earlier research\n- You can iteratively deepen an investigation across multiple rounds\n\n## All Specialized Agent Types\n\nBeyond the 4 basic types, Claude Code has many specialized agents:\n\n| Type | Purpose | Key Capability |\n|------|---------|----------------|\n| **Explore** | Fast codebase search | Read-only, fastest for finding things |\n| **Bash** | Shell command execution | Runs commands in isolated shell |\n| **Plan** | Architecture planning | Read-only, designs implementation steps |\n| **general-purpose** | Any multi-step task | Full tool access, most flexible |\n| **feature-dev:code-reviewer** | Code review | Finds bugs, security issues, quality problems |\n| **feature-dev:code-explorer** | Deep code analysis | Traces execution paths, maps architecture |\n| **feature-dev:code-architect** | Feature design | Creates implementation blueprints |\n| **code-simplifier:code-simplifier** | Code cleanup | Simplifies and refines code |\n\n## Choosing the Right Agent\n\n- **Need to find something quickly?** -> Explore (fastest, read-only)\n- **Need to run commands?** -> Bash (isolated execution)\n- **Need an implementation plan?** -> Plan or code-architect\n- **Need deep code analysis?** -> code-explorer (traces execution paths)\n- **Need code reviewed for issues?** -> code-reviewer (finds bugs and vulnerabilities)\n- **Need code cleaned up?** -> code-simplifier (refactors for clarity)\n- **Need anything else?** -> general-purpose (full access)\n\nThe key principle: **use the most constrained agent that can do the job**. Read-only agents (Explore, Plan) are safer because they can't accidentally modify files.\n\n## Your Exercise\n\nThis workspace contains an **e-commerce API** with controllers, services, middleware, and routes. Hidden in the codebase are **4 dead functions** -- functions that are defined but never imported or called anywhere:\n\n- `deprecated_getUser` in `src/controllers/users.js`\n- `oldFormatPrice` in `src/controllers/products.js`\n- `unusedMiddleware` in `src/middleware/auth.js`\n- `legacyValidate` in `src/middleware/validation.js`\n\n**Your task: Use an Explore subagent to map the codebase and find the dead code, then remove all 4 dead functions without breaking anything.**\n\nSuggested approach:\n1. Ask Claude to \"use an explore agent to map this project's architecture and find all function definitions\"\n2. Resume the agent (or start a new one) to \"find which functions are never imported or called anywhere\"\n3. Remove the 4 dead functions\n4. Verify the existing routes and functionality still work (the route patterns in src/api/routes.js should be unchanged)\n\nRun `/dojo check` when done.",
  "difficulty": "advanced",
  "xpReward": 350,
  "estimatedMinutes": 15,
  "skills": ["agent-resume", "dead-code-removal", "codebase-analysis"],

  "setup": {
    "workingDir": "~/dojo-workspace/challenge-11-003",
    "initialFiles": [
      {
        "path": "README.md",
        "content": "# E-Commerce API\n\nA full-featured e-commerce REST API with users, products, and orders.\n\n## Structure\n\n- `src/api/routes.js` — Route definitions\n- `src/controllers/` — Request handlers (users, products, orders)\n- `src/middleware/` — Auth, validation, rate limiting\n- `src/services/` — Business logic (not yet created)\n"
      },
      {
        "path": "src/api/routes.js",
        "content": "const express = require('express');\nconst router = express.Router();\nconst { authenticate } = require('../middleware/auth');\nconst { validate } = require('../middleware/validation');\nconst { rateLimit } = require('../middleware/rateLimit');\nconst userController = require('../controllers/users');\nconst productController = require('../controllers/products');\nconst orderController = require('../controllers/orders');\n\n// User routes\nrouter.post('/users/register', validate('register'), userController.register);\nrouter.post('/users/login', validate('login'), userController.login);\nrouter.get('/users/profile', authenticate, userController.getProfile);\nrouter.put('/users/profile', authenticate, validate('updateProfile'), userController.updateProfile);\n\n// Product routes\nrouter.get('/products', productController.list);\nrouter.get('/products/:id', productController.getById);\nrouter.post('/products', authenticate, validate('createProduct'), productController.create);\nrouter.put('/products/:id', authenticate, validate('updateProduct'), productController.update);\nrouter.delete('/products/:id', authenticate, productController.remove);\n\n// Order routes\nrouter.get('/orders', authenticate, orderController.list);\nrouter.post('/orders', authenticate, rateLimit(10), validate('createOrder'), orderController.create);\nrouter.get('/orders/:id', authenticate, orderController.getById);\nrouter.patch('/orders/:id/status', authenticate, validate('updateStatus'), orderController.updateStatus);\n\nmodule.exports = router;\n"
      },
      {
        "path": "src/controllers/users.js",
        "content": "const UserService = require('../services/UserService');\n\n// DEAD CODE: This function was replaced by getProfile but never removed\nfunction deprecated_getUser(req, res) {\n  return res.json({ message: 'This endpoint is deprecated' });\n}\n\nmodule.exports = {\n  async register(req, res, next) {\n    try {\n      const user = await UserService.create(req.body);\n      const token = await UserService.generateToken(user);\n      res.status(201).json({ user, token });\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async login(req, res, next) {\n    try {\n      const { email, password } = req.body;\n      const { user, token } = await UserService.authenticate(email, password);\n      res.json({ user, token });\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async getProfile(req, res, next) {\n    try {\n      const user = await UserService.findById(req.user.id);\n      res.json(user);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async updateProfile(req, res, next) {\n    try {\n      const user = await UserService.update(req.user.id, req.body);\n      res.json(user);\n    } catch (err) {\n      next(err);\n    }\n  }\n};\n"
      },
      {
        "path": "src/controllers/products.js",
        "content": "const ProductService = require('../services/ProductService');\n\n// DEAD CODE: Old price formatting, replaced by client-side formatting\nfunction oldFormatPrice(cents) {\n  return '$' + (cents / 100).toFixed(2);\n}\n\nmodule.exports = {\n  async list(req, res, next) {\n    try {\n      const products = await ProductService.findAll(req.query);\n      res.json(products);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async getById(req, res, next) {\n    try {\n      const product = await ProductService.findById(req.params.id);\n      res.json(product);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async create(req, res, next) {\n    try {\n      const product = await ProductService.create(req.body);\n      res.status(201).json(product);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async update(req, res, next) {\n    try {\n      const product = await ProductService.update(req.params.id, req.body);\n      res.json(product);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async remove(req, res, next) {\n    try {\n      await ProductService.delete(req.params.id);\n      res.status(204).end();\n    } catch (err) {\n      next(err);\n    }\n  }\n};\n"
      },
      {
        "path": "src/controllers/orders.js",
        "content": "const OrderService = require('../services/OrderService');\n\nmodule.exports = {\n  async list(req, res, next) {\n    try {\n      const orders = await OrderService.findByUser(req.user.id);\n      res.json(orders);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async create(req, res, next) {\n    try {\n      const order = await OrderService.create(req.user.id, req.body);\n      res.status(201).json(order);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async getById(req, res, next) {\n    try {\n      const order = await OrderService.findById(req.params.id, req.user.id);\n      res.json(order);\n    } catch (err) {\n      next(err);\n    }\n  },\n\n  async updateStatus(req, res, next) {\n    try {\n      const order = await OrderService.updateStatus(req.params.id, req.body.status);\n      res.json(order);\n    } catch (err) {\n      next(err);\n    }\n  }\n};\n"
      },
      {
        "path": "src/middleware/auth.js",
        "content": "const jwt = require('jsonwebtoken');\n\nfunction authenticate(req, res, next) {\n  const token = req.headers.authorization?.split(' ')[1];\n  if (!token) return res.status(401).json({ error: 'Authentication required' });\n  try {\n    req.user = jwt.verify(token, process.env.JWT_SECRET);\n    next();\n  } catch {\n    res.status(401).json({ error: 'Invalid or expired token' });\n  }\n}\n\n// DEAD CODE: Was planned for admin panel but never wired up\nfunction unusedMiddleware(req, res, next) {\n  console.log('This middleware is never used');\n  next();\n}\n\nmodule.exports = { authenticate, unusedMiddleware };\n"
      },
      {
        "path": "src/middleware/validation.js",
        "content": "const schemas = {\n  register: { required: ['email', 'password', 'name'] },\n  login: { required: ['email', 'password'] },\n  updateProfile: { required: ['name'] },\n  createProduct: { required: ['name', 'price'] },\n  updateProduct: { required: ['name', 'price'] },\n  createOrder: { required: ['productId', 'quantity'] },\n  updateStatus: { required: ['status'] }\n};\n\n// DEAD CODE: Replaced by the validate() function below\nfunction legacyValidate(fields, body) {\n  const missing = fields.filter(f => !body[f]);\n  return missing.length === 0;\n}\n\nfunction validate(schemaName) {\n  return (req, res, next) => {\n    const schema = schemas[schemaName];\n    if (!schema) return next();\n    const missing = schema.required.filter(f => !req.body[f]);\n    if (missing.length) {\n      return res.status(400).json({ error: `Missing fields: ${missing.join(', ')}` });\n    }\n    next();\n  };\n}\n\nmodule.exports = { validate, legacyValidate };\n"
      },
      {
        "path": "src/middleware/rateLimit.js",
        "content": "const limits = new Map();\n\nfunction rateLimit(maxPerMinute) {\n  return (req, res, next) => {\n    const key = `${req.ip}-${req.path}`;\n    const now = Date.now();\n    const windowStart = now - 60000;\n    \n    if (!limits.has(key)) limits.set(key, []);\n    const hits = limits.get(key).filter(t => t > windowStart);\n    \n    if (hits.length >= maxPerMinute) {\n      return res.status(429).json({ error: 'Rate limit exceeded' });\n    }\n    \n    hits.push(now);\n    limits.set(key, hits);\n    next();\n  };\n}\n\nmodule.exports = { rateLimit };\n"
      }
    ],
    "cleanBefore": true
  },

  "objectives": [
    {
      "id": "obj-1",
      "description": "Dead function deprecated_getUser removed from controllers/users.js",
      "type": "file_not_contains",
      "target": "src/controllers/users.js",
      "pattern": "deprecated_getUser",
      "required": true
    },
    {
      "id": "obj-2",
      "description": "Dead function oldFormatPrice removed from controllers/products.js",
      "type": "file_not_contains",
      "target": "src/controllers/products.js",
      "pattern": "oldFormatPrice",
      "required": true
    },
    {
      "id": "obj-3",
      "description": "Dead function unusedMiddleware removed from middleware/auth.js",
      "type": "file_not_contains",
      "target": "src/middleware/auth.js",
      "pattern": "unusedMiddleware",
      "required": true
    },
    {
      "id": "obj-4",
      "description": "Dead function legacyValidate removed from middleware/validation.js",
      "type": "file_not_contains",
      "target": "src/middleware/validation.js",
      "pattern": "legacyValidate",
      "required": true
    },
    {
      "id": "obj-5",
      "description": "Existing route patterns are still intact (functionality preserved)",
      "type": "file_contains",
      "target": "src/api/routes.js",
      "pattern": "/users/register|/users/login|/products|/orders",
      "required": true
    }
  ],

  "bonusObjectives": [
    {
      "id": "bonus-1",
      "description": "Dead code comments (DEAD CODE:) also removed, not just the functions",
      "type": "file_not_contains",
      "target": "src/controllers/users.js",
      "pattern": "DEAD CODE",
      "xpBonus": 50
    }
  ],

  "hints": [
    {
      "level": 1,
      "text": "Start by asking Claude to use an explore agent to find all function definitions across the project. Then resume it to check which functions are never imported or called anywhere else.",
      "xpCost": 25
    },
    {
      "level": 2,
      "text": "The 4 dead functions are: deprecated_getUser (controllers/users.js), oldFormatPrice (controllers/products.js), unusedMiddleware (middleware/auth.js), and legacyValidate (middleware/validation.js). Each has a 'DEAD CODE' comment above it. Remove both the function and its comment.",
      "xpCost": 70
    },
    {
      "level": 3,
      "text": "For each dead function: (1) Delete the function definition and its DEAD CODE comment. (2) For unusedMiddleware: also remove it from module.exports in auth.js (change to just { authenticate }). (3) For legacyValidate: also remove it from module.exports in validation.js (change to just { validate }). (4) Verify routes.js still references the live functions correctly.",
      "xpCost": 125
    }
  ],

  "solution": {
    "approach": "Use an Explore agent to map the codebase and identify dead functions, then resume it to verify which are never called. Remove all 4 dead functions and their exports while preserving all live functionality.",
    "example": "Explore to find all functions, resume to find dead code, then remove deprecated_getUser, oldFormatPrice, unusedMiddleware, and legacyValidate along with their DEAD CODE comments and exports.",
    "alternativeApproaches": [
      "Use a code-reviewer agent to find dead code automatically",
      "Grep for all function definitions, then grep for their usage to find the unused ones"
    ]
  },

  "learningPoints": [
    "Agents can be resumed by ID to continue with full context preserved",
    "Resuming avoids re-explaining context and builds on prior work",
    "Specialized agents (code-reviewer, code-explorer, code-architect) exist for specific tasks",
    "Choosing the right agent type makes tasks faster and more focused",
    "Read-only agents (Explore, Plan) are safer for research tasks -- they can't accidentally modify files",
    "When removing dead code, always verify that existing functionality is preserved"
  ],

  "nextChallenge": "11-004"
}
