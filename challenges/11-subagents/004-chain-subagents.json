{
  "id": "11-004",
  "module": "subagents",
  "title": "Custom Plugin Agents",
  "description": "Learn to create your own custom subagent as part of a Claude Code plugin. Custom agents extend Claude Code with specialized autonomous workers.",
  "difficulty": "advanced",
  "xpReward": 400,
  "estimatedMinutes": 20,
  "skills": ["agent-creation", "plugin-agents"],

  "setup": {
    "workingDir": "~/dojo-workspace/challenge-11-004",
    "initialFiles": [
      {
        "path": "README.md",
        "content": "# Challenge: Custom Plugin Agents\n\nCreate your own subagent as part of a Claude Code plugin.\n\n## What Are Custom Agents?\n\nPlugins can define custom subagent types that Claude Code can spawn.\nEach agent is a markdown file in the `agents/` folder with:\n\n1. **YAML frontmatter** - metadata and configuration\n2. **System prompt** - instructions for how the agent behaves\n\n## Agent File Structure\n\n```markdown\n---\ndescription: When to trigger this agent (Claude reads this to decide)\ntools: Read, Grep, Glob, Bash  # Which tools this agent can use\n---\n\n# Agent Name\n\nYou are a specialized agent that...\n\n## Your Task\n...\n\n## Guidelines\n...\n```\n\n## Key Frontmatter Fields\n\n| Field | Purpose |\n|-------|--------|\n| `description` | When this agent should be triggered (CRITICAL - Claude uses this) |\n| `tools` | Comma-separated list of allowed tools |\n\n## How Custom Agents Get Triggered\n\nClaude reads the `description` field to decide when to use your agent.\nWrite descriptions with clear trigger conditions:\n\n- GOOD: \"Use when user asks to review code for security vulnerabilities\"\n- BAD: \"Security agent\"\n\n## Objectives\n1. Create a plugin with a custom security-reviewer agent\n2. The agent should have proper frontmatter and a detailed system prompt\n3. Test it by asking it to review the sample vulnerable code\n4. Create a security-report.md with the review findings\n"
      },
      {
        "path": ".claude-plugin/plugin.json",
        "content": "{\n  \"name\": \"security-tools\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Security review tools for code analysis\"\n}\n"
      },
      {
        "path": "sample-code/api.js",
        "content": "const express = require('express');\nconst mysql = require('mysql');\nconst router = express.Router();\n\nconst db = mysql.createConnection({\n  host: 'localhost',\n  user: 'root',\n  password: 'password123',\n  database: 'myapp'\n});\n\n// Login endpoint\nrouter.post('/login', (req, res) => {\n  const { username, password } = req.body;\n  \n  // SQL Injection vulnerability\n  const sql = `SELECT * FROM users WHERE username='${username}' AND password='${password}'`;\n  db.query(sql, (err, results) => {\n    if (results.length > 0) {\n      // Hardcoded JWT secret\n      const token = jwt.sign({ user: results[0] }, 'my-secret-key-123');\n      res.json({ token });\n    } else {\n      res.status(401).json({ error: 'Invalid credentials' });\n    }\n  });\n});\n\n// User data endpoint - no auth check!\nrouter.get('/users/:id', (req, res) => {\n  const sql = `SELECT * FROM users WHERE id=${req.params.id}`;\n  db.query(sql, (err, results) => {\n    // Returns password hash to client!\n    res.json(results[0]);\n  });\n});\n\n// File upload - no validation\nrouter.post('/upload', (req, res) => {\n  const filename = req.body.filename;\n  // Path traversal vulnerability\n  const path = `/uploads/${filename}`;\n  fs.writeFileSync(path, req.body.data);\n  res.json({ path });\n});\n\n// Debug endpoint left in production\nrouter.get('/debug/env', (req, res) => {\n  res.json(process.env);\n});\n\n// Logging sensitive data\nrouter.use((req, res, next) => {\n  console.log('Request:', {\n    url: req.url,\n    headers: req.headers,\n    body: req.body  // Logs passwords and tokens!\n  });\n  next();\n});\n\nmodule.exports = router;\n"
      }
    ],
    "cleanBefore": true
  },

  "objectives": [
    {
      "id": "obj-1",
      "description": "Create agents/security-reviewer.md",
      "type": "file_exists",
      "target": "agents/security-reviewer.md",
      "required": true
    },
    {
      "id": "obj-2",
      "description": "Agent has description in frontmatter for triggering",
      "type": "file_contains",
      "target": "agents/security-reviewer.md",
      "pattern": "description:",
      "required": true
    },
    {
      "id": "obj-3",
      "description": "Agent has tools defined in frontmatter",
      "type": "file_contains",
      "target": "agents/security-reviewer.md",
      "pattern": "tools:",
      "required": true
    },
    {
      "id": "obj-4",
      "description": "Agent system prompt covers security review methodology",
      "type": "file_contains",
      "target": "agents/security-reviewer.md",
      "pattern": "[Ss]ecurity|[Vv]ulnerabilit|SQL.?[Ii]njection|XSS|OWASP",
      "required": true
    },
    {
      "id": "obj-5",
      "description": "Create security-report.md with findings",
      "type": "file_exists",
      "target": "security-report.md",
      "required": true
    }
  ],

  "bonusObjectives": [
    {
      "id": "bonus-1",
      "description": "Report identifies at least 4 distinct vulnerabilities",
      "type": "file_contains",
      "target": "security-report.md",
      "pattern": "SQL|[Hh]ardcoded|[Pp]ath.?[Tt]raversal|[Dd]ebug|[Ll]ogging|[Aa]uth|[Pp]assword",
      "xpBonus": 75
    },
    {
      "id": "bonus-2",
      "description": "Report includes severity ratings",
      "type": "file_contains",
      "target": "security-report.md",
      "pattern": "[Cc]ritical|[Hh]igh|[Mm]edium|[Ll]ow|[Ss]everity",
      "xpBonus": 50
    }
  ],

  "hints": [
    {
      "level": 1,
      "text": "Create agents/security-reviewer.md with YAML frontmatter (description, tools) and a system prompt that tells the agent how to review code for security issues.",
      "xpCost": 30
    },
    {
      "level": 2,
      "text": "For the frontmatter, use: description: 'Use when reviewing code for security vulnerabilities' and tools: 'Read, Grep, Glob'. The system prompt should list categories to check: injection, auth, secrets, data exposure, etc.",
      "xpCost": 80
    },
    {
      "level": 3,
      "text": "After creating the agent file, ask Claude to use the security-reviewer agent on sample-code/api.js. It should find: SQL injection (string interpolation in queries), hardcoded secrets (JWT key, DB password), missing auth (GET /users/:id), path traversal (/upload), debug endpoint, and sensitive data logging.",
      "xpCost": 150
    }
  ],

  "solution": {
    "approach": "Create a custom agent markdown file with proper frontmatter and system prompt, then use it to review vulnerable code.",
    "example": "Create agents/security-reviewer.md, then ask Claude to use it on the sample code",
    "alternativeApproaches": [
      "Build a security review agent and test it on the vulnerable sample code",
      "Define a custom subagent for security analysis with proper trigger description"
    ]
  },

  "learningPoints": [
    "Custom agents are markdown files in the agents/ folder of a plugin",
    "The description field in frontmatter determines when Claude triggers the agent",
    "The tools field restricts what the agent can do (principle of least privilege)",
    "A good system prompt defines methodology, not just goals",
    "Custom agents make specialized workflows repeatable"
  ],

  "nextChallenge": "12-001"
}
