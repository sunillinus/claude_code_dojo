{
  "id": "08-002",
  "module": "effective-prompting",
  "title": "Iterative Refinement",
  "description": "Learn to build on Claude Code's output through targeted follow-up prompts, then practice by building a complete task API through iterative refinement.\n\n## Why Iteration Works\n\nClaude Code maintains conversation context. Each follow-up prompt builds on everything before -- the code it wrote, decisions it made, patterns it established. This is your superpower.\n\nInstead of one perfect prompt, you can:\n1. Start with a reasonable first attempt\n2. Review what Claude produced\n3. Give targeted feedback to refine it\n4. Repeat until exactly right\n\nThis is often faster than specifying everything upfront, because you react to what you see rather than predict what you need.\n\n## The Refinement Loop\n\n```\nInitial Prompt -> Review Output -> Targeted Feedback -> Review -> Accept\n                                         |\n                                   (or refine again)\n```\n\n## 5 Types of Refinement\n\n### 1. Targeted Feedback\nKeep what works, change what doesn't.\n- \"Keep the structure but change naming to camelCase\"\n- \"The validation is great, but move it to a separate function\"\n\n### 2. Course Correction\nRedirect when Claude went in the wrong direction.\n- \"I need a REST endpoint, not a GraphQL resolver\"\n- \"This should return a Promise, not use callbacks\"\n\n### 3. Narrowing Scope\nFocus on a specific part.\n- \"Focus only on the validation logic -- the rest is fine\"\n- \"Just improve the error messages, don't change control flow\"\n\n### 4. Widening Scope\nExtend a proven pattern to new areas.\n- \"Apply that same error handling pattern to the other 3 files\"\n- \"Create similar endpoints for products and orders\"\n\n### 5. Incremental Enhancement\nAdd features one at a time.\n- \"Now add input validation to the create endpoint\"\n- \"Add pagination to the GET /tasks endpoint\"\n\n## When to Start Over vs Refine\n\n**Refine when:** the overall approach is sound and you need specific changes.\n\n**Start over when:** the fundamental approach is wrong, or context pollution has made Claude's model inconsistent (sign: Claude reintroduces things you asked it to remove).\n\n## Anti-Patterns\n\n- **\"Make it better\"** -- too vague. Better: \"Make error messages include the field name\"\n- **Contradicting yourself** -- \"Use classes\" then \"use functions\" then \"maybe classes\" creates confusion\n- **Too many changes at once** -- one or two per iteration keeps things manageable\n\n## Your Exercise\n\nBuild a complete **task management API** in `server.js` through iterative refinement. The file starts as a minimal Express skeleton. Through multiple refinement steps, build it up to include:\n\n1. **CRUD routes** (GET /tasks, POST /tasks, PUT /tasks/:id, DELETE /tasks/:id)\n2. **Input validation** (reject requests missing required fields like title)\n3. **Error handling** (try/catch around async operations)\n4. **Pagination** (GET /tasks supports page/limit query parameters)\n\nDon't try to get everything in one prompt. Start simple and iterate:\n- Prompt 1: \"Create basic CRUD routes for tasks\"\n- Prompt 2: \"Add input validation for POST -- require title\"\n- Prompt 3: \"Add try/catch error handling to all routes\"\n- Prompt 4: \"Add pagination to GET /tasks with page and limit query params\"\n\nRun `/dojo check` when done.",
  "difficulty": "intermediate",
  "xpReward": 125,
  "estimatedMinutes": 12,
  "skills": ["iteration", "feedback-loop", "api-development"],

  "setup": {
    "workingDir": "~/dojo-workspace/challenge-08-002",
    "initialFiles": [
      {
        "path": "README.md",
        "content": "# Task API\n\nA simple Express REST API for task management, built through iterative refinement.\n\n## Files\n\n- `server.js` — Express server with task endpoints\n- `package.json` — Project configuration\n"
      },
      {
        "path": "package.json",
        "content": "{\n  \"name\": \"task-api\",\n  \"version\": \"1.0.0\",\n  \"type\": \"module\",\n  \"dependencies\": {\n    \"express\": \"^4.18.0\"\n  }\n}\n"
      },
      {
        "path": "server.js",
        "content": "// Starting point: a minimal Express server\n// Build your task API through iterative refinement\n\nimport express from 'express';\n\nconst app = express();\napp.use(express.json());\n\n// Your task endpoints will go here\n\napp.listen(3000, () => {\n  console.log('Server running on port 3000');\n});\n\nexport default app;\n"
      }
    ],
    "cleanBefore": true
  },

  "objectives": [
    {
      "id": "obj-1",
      "description": "Server has CRUD route handlers (GET, POST, PUT/PATCH, or DELETE)",
      "type": "file_contains",
      "target": "server.js",
      "pattern": "app\\.(get|post|put|delete|patch)",
      "required": true
    },
    {
      "id": "obj-2",
      "description": "Input validation exists (checks for required fields, returns 400 for missing data)",
      "type": "file_contains",
      "target": "server.js",
      "pattern": "!.*title|!.*name|valid|400|[Mm]issing",
      "required": true
    },
    {
      "id": "obj-3",
      "description": "Error handling exists (try/catch blocks)",
      "type": "file_contains",
      "target": "server.js",
      "pattern": "try|catch",
      "required": true
    },
    {
      "id": "obj-4",
      "description": "Pagination support (page, limit, offset, or skip parameters)",
      "type": "file_contains",
      "target": "server.js",
      "pattern": "page|limit|offset|skip",
      "required": true
    }
  ],

  "bonusObjectives": [
    {
      "id": "bonus-1",
      "description": "Routes use /tasks path (RESTful naming)",
      "type": "file_contains",
      "target": "server.js",
      "pattern": "/tasks",
      "xpBonus": 25
    }
  ],

  "hints": [
    {
      "level": 1,
      "text": "Start simple: 'Create basic CRUD routes for a task list in server.js. Tasks have an id, title, and completed status. Store them in an in-memory array.' Review what Claude produces, then build on it.",
      "xpCost": 10
    },
    {
      "level": 2,
      "text": "After CRUD routes exist, iterate: (1) 'Add input validation to POST /tasks -- return 400 if title is missing.' (2) 'Add try/catch error handling to all route handlers.' (3) 'Add pagination to GET /tasks with page and limit query parameters.' Each is a targeted refinement.",
      "xpCost": 25
    },
    {
      "level": 3,
      "text": "If you want to do it in one shot, ask: 'In server.js, create a task API with: (1) CRUD routes at /tasks (GET list, POST create, PUT update, DELETE), (2) In-memory storage with id/title/completed, (3) Input validation returning 400 for missing title on POST, (4) try/catch on all async handlers, (5) Pagination on GET /tasks using page and limit query params.' But the exercise is about practicing iteration -- try building it up step by step instead.",
      "xpCost": 50
    }
  ],

  "solution": {
    "approach": "Build the task API through 4 iterative prompts: CRUD routes first, then validation, then error handling, then pagination. Each prompt refines the previous output.",
    "example": "Prompt 1: basic CRUD. Prompt 2: add validation (targeted enhancement). Prompt 3: add try/catch (targeted enhancement). Prompt 4: add pagination (targeted enhancement).",
    "alternativeApproaches": [
      "Build everything in one specific prompt covering all 4 requirements",
      "Start with routes and validation together, then add error handling and pagination"
    ]
  },

  "learningPoints": [
    "Iteration leverages Claude Code's conversation context -- each prompt builds on the last",
    "Five refinement types: targeted feedback, course correction, narrowing, widening, incremental enhancement",
    "Targeted feedback ('keep X but change Y') is the most efficient refinement type",
    "Watch for context pollution -- if Claude reintroduces removed features, start fresh",
    "One to two changes per iteration keeps refinement manageable and reviewable",
    "Starting simple and iterating is often faster than specifying everything upfront"
  ],

  "nextChallenge": "08-003"
}
